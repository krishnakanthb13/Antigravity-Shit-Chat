<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Antigravity Phone Connect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Premium Dark Theme Tokens (Slate Palette) */
            --bg-app: #0f172a;
            /* Slate 950 */
            --bg-panel: #1e293b;
            /* Slate 800 */
            --bg-input: #334155;
            /* Slate 700 */
            --border: #334155;
            /* Slate 700 */
            --text-main: #f8fafc;
            /* Slate 50 */
            --text-muted: #94a3b8;
            /* Slate 400 */
            --accent: #3b82f6;
            /* Blue 500 */
            --accent-hover: #2563eb;
            /* Blue 600 */
            --success: #22c55e;
            /* Green 500 */
            --warning: #eab308;
            /* Yellow 500 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent overscroll bounce on iOS */
        html {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-app);
            color: var(--text-main);
            height: 100%;
            /* Revert to standard percent height */
            position: relative;
            /* Remove fixed */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Keep internal scroll */
        }


        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 50;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stop-btn {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
            display: none;
            /* Only show when needed or always show? User asked for feature 1 */
            /* I'll make it always visible or toggleable */
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stop-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.1);
        }

        .refresh-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-dot.disconnected {
            background: var(--warning);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            background: var(--bg-app);
        }

        .chat-content {
            min-height: 100%;
            padding: 20px 16px;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-muted);
            gap: 12px;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--bg-input);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 8px;
            padding: 8px 16px 0 16px;
            overflow-x: auto;
            background: var(--bg-panel);
        }

        .action-chip {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .action-chip:active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Input Section */
        .input-section {
            background: var(--bg-panel);
            border-top: none;
            /* Removed border since actions are above */
            padding: 8px 16px 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-wrapper {
            display: flex;
            gap: 4px;
            align-items: center;
            /* Center text vertically */
            background-color: var(--bg-input);
            padding: 4px 4px 4px 16px;
            /* Reduced vertical padding */
            border-radius: 24px;
            border: 1px solid var(--border);
            transition: all 0.2s;
            min-height: 48px;
            background-image: none !important;
            box-shadow: none !important;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
            background-color: var(--bg-panel);
            /* Soft glow instead of hard shadow */
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.2) !important;
        }

        textarea {
            flex: 1;
            /* NUCLEAR OPTION for cleanup */
            background-color: transparent !important;
            background: rgba(0, 0, 0, 0) !important;
            background-image: none !important;
            border: none !important;
            color: #ffffff !important;
            padding: 10px 0;
            /* Vertical center visual */
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 24px;
            /* Matches line height */
            max-height: 160px;
            line-height: 1.5;
            opacity: 1;
            margin: 0;
            outline: none !important;
            box-shadow: none !important;
            /* Vendor Resets */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0;
            caret-color: var(--accent);
        }

        /* Specific fix for Chrome/Android autofill background */
        textarea:-webkit-autofill,
        textarea:-webkit-autofill:hover,
        textarea:-webkit-autofill:focus {
            -webkit-text-fill-color: #ffffff;
            -webkit-box-shadow: 0 0 0px 1000px var(--bg-input) inset;
            transition: background-color 5000s ease-in-out 0s;
        }

        textarea:focus {
            outline: none;
        }

        /* Hide scrollbar on textarea but allow scroll */
        textarea::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .send-btn {
            background: transparent;
            border: none;
            color: var(--accent);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            align-self: flex-end;
            /* Keep button at bottom when text wraps */
            margin-bottom: 2px;
        }

        .send-btn:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .send-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            stroke: none;
        }

        .send-btn:active {
            transform: scale(0.92);
            background: var(--accent-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-input);
        }

        /* Floating Action Button (Scroll Down) */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-panel);
            color: var(--text-main);
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .fab.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .fab:hover {
            background: var(--bg-input);
        }

        .fab svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2.5;
        }

        @keyframes spin-once {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spin-anim {
            animation: spin-once 0.5s ease-out;
        }

        /* Settings Bar */
        .settings-bar {
            background: var(--bg-panel);
            padding: 8px 16px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .setting-chip {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setting-chip:active {
            transform: scale(0.95);
        }

        .setting-chip.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-panel {
            background: var(--bg-panel);
            width: 100%;
            max-width: 500px;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
        }

        .modal-option {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
        }

        .modal-option:last-child {
            border-bottom: none;
        }

        .modal-option:active {
            background: var(--bg-input);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <h1>
            <span>Antigravity Phone Connect</span>
        </h1>

        <div class="header-controls">
            <button class="stop-btn" id="stopBtn" aria-label="STOP">
                <span>STOP</span>
            </button>
            <button class="refresh-btn" id="refreshBtn" aria-label="Refresh">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 4v6h-6"></path>
                    <path d="M1 20v-6h6"></path>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
            </button>
            <div class="status-badge">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </header>

    <!-- Settings Bar -->
    <div class="settings-bar">
        <div class="setting-chip" id="modeBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
            </svg>
            <span id="modeText">Fast</span>
        </div>
        <div class="setting-chip" id="modelBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4" />
                <path d="M12 8h.01" />
            </svg>
            <span id="modelText">Select Model</span>
        </div>
        <div class="setting-chip" id="syncStats" style="cursor: default; border: none; background: transparent;">
            <span id="statsText" style="font-size: 10px; opacity: 0.6;">Syncing...</span>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-content" id="chatContent">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Waiting for snapshot...</p>
            </div>
        </div>
    </div>

    <!-- Scroll to Bottom FAB -->
    <button class="fab" id="scrollToBottom" aria-label="Scroll to bottom">
        <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 5v14M19 12l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
    </button>

    <path d="M12 5v14M19 12l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
    </button>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <div class="action-chip" onclick="quickAction('Continue')">Continue</div>
        <div class="action-chip" onclick="quickAction('Please fix the bugs in this file.')">Fix Bugs</div>
        <div class="action-chip" onclick="quickAction('Please create documentation for this.')">Create Docs</div>
    </div>

    <!-- Input Section -->
    <div class="input-section">
        <div class="input-wrapper">
            <textarea id="messageInput" placeholder="Message..." rows="1"></textarea>



            <button class="send-btn" id="sendBtn" aria-label="Send">
                <svg viewBox="0 0 24 24">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"
                        style="fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-panel" id="modalPanel">
            <div class="modal-title" id="modalTitle">Select Option</div>
            <div id="modalList"></div>
            <div style="margin-top:20px; text-align:center;">
                <button onclick="closeModal()"
                    style="background:transparent; border:none; color:var(--text-muted); padding:10px;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const chatContent = document.getElementById('chatContent');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const scrollToBottomBtn = document.getElementById('scrollToBottom');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const refreshBtn = document.getElementById('refreshBtn');
        const stopBtn = document.getElementById('stopBtn');

        const modeBtn = document.getElementById('modeBtn');
        const modelBtn = document.getElementById('modelBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalList = document.getElementById('modalList');
        const modalTitle = document.getElementById('modalTitle');
        const modeText = document.getElementById('modeText');
        const modelText = document.getElementById('modelText');

        // --- State ---
        let autoRefreshEnabled = true;
        let userIsScrolling = false;
        let lastScrollPosition = 0;
        let ws = null;
        let idleTimer = null;
        let lastHash = '';
        let currentMode = 'Fast';

        // --- Sync State (Desktop is Always Priority) ---
        async function fetchAppState() {
            try {
                const res = await fetch('/app-state');
                const data = await res.json();

                // Mode Sync (Fast/Planning) - Desktop is source of truth
                if (data.mode && data.mode !== 'Unknown') {
                    modeText.textContent = data.mode;
                    modeBtn.classList.toggle('active', data.mode === 'Planning');
                    currentMode = data.mode;
                }

                // Model Sync - Desktop is source of truth
                if (data.model && data.model !== 'Unknown') {
                    modelText.textContent = data.model;
                }

                console.log('[SYNC] State refreshed from Desktop:', data);
            } catch (e) { console.error('[SYNC] Failed to sync state', e); }
        }

        // --- Models ---
        const MODELS = [
            "Gemini 3 Pro (High)",
            "Gemini 3 Pro (Low)",
            "Gemini 3 Flash",
            "Claude Sonnet 4.5",
            "Claude Sonnet 4.5 (Thinking)",
            "Claude Opus 4.5 (Thinking)",
            "GPT-OSS 120B (Medium)"
        ];

        // --- WebSocket ---
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);

            ws.onopen = () => {
                console.log('WS Connected');
                updateStatus(true);
                loadSnapshot();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'snapshot_update' && autoRefreshEnabled && !userIsScrolling) {
                    loadSnapshot();
                }
            };

            ws.onclose = () => {
                console.log('WS Disconnected');
                updateStatus(false);
                setTimeout(connectWebSocket, 2000);
            };
        }

        function updateStatus(connected) {
            if (connected) {
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                statusText.textContent = 'Live';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                statusText.textContent = 'Reconnecting';
            }
        }

        // --- Rendering ---
        async function loadSnapshot() {
            try {
                // Add spin animation to refresh button
                const icon = refreshBtn.querySelector('svg');
                icon.classList.remove('spin-anim');
                void icon.offsetWidth; // trigger reflow
                icon.classList.add('spin-anim');

                const response = await fetch('/snapshot');
                if (!response.ok) {
                    if (response.status === 503) return;
                    throw new Error('Failed to load');
                }

                const data = await response.json();

                const scrollPos = chatContainer.scrollTop;
                const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 120;

                // --- UPDATE STATS ---
                if (data.stats) {
                    const kbs = Math.round((data.stats.htmlSize + data.stats.cssSize) / 1024);
                    const nodes = data.stats.nodes;
                    const statsText = document.getElementById('statsText');
                    if (statsText) statsText.textContent = `${nodes} Nodes Â· ${kbs}KB`;
                }

                // --- DARK MODE INJECTION ---
                const darkModeOverrides = `
                    <style>
                        ${data.css}

                        /* --- FORCE DARK MODE OVERRIDES --- */
                        :root {
                            --bg-app: #0f172a;
                            --text-main: #f8fafc;
                            --text-muted: #94a3b8;
                            --border-color: #334155;
                        }

                        #cascade {
                            background-color: transparent !important;
                            color: var(--text-main) !important;
                            font-family: 'Inter', system-ui, sans-serif !important;
                            position: relative !important;
                            height: auto !important;
                            width: 100% !important;
                        }

                        #cascade * {
                            position: static !important;
                        }

                        #cascade p, #cascade h1, #cascade h2, #cascade h3, #cascade h4, #cascade h5, #cascade span, #cascade div, #cascade li {
                            color: inherit !important;
                        }

                        #cascade a {
                            color: #60a5fa !important;
                            text-decoration: underline;
                        }

                        pre, code, .monaco-editor-background, [class*="terminal"] {
                            background-color: #1e293b !important;
                            color: #e2e8f0 !important;
                            font-family: 'JetBrains Mono', monospace !important;
                            border-radius: 6px;
                            border: 1px solid #334155;
                        }
                        
                        blockquote {
                            border-left: 3px solid #3b82f6 !important;
                            background: rgba(59, 130, 246, 0.1) !important;
                            color: #cbd5e1 !important;
                            padding: 8px 12px !important;
                            margin: 8px 0 !important;
                        }

                        table {
                            border-collapse: collapse !important;
                            width: 100% !important;
                            border: 1px solid #334155 !important;
                        }
                        th, td {
                            border: 1px solid #334155 !important;
                            padding: 8px !important;
                            color: #e2e8f0 !important;
                        }

                        ::-webkit-scrollbar {
                            width: 0 !important;
                        }
                        
                        [style*="background-color: rgb(255, 255, 255)"],
                        [style*="background-color: white"],
                        [style*="background: white"] {
                            background-color: transparent !important;
                        }
                    </style>
                `;

                chatContent.innerHTML = darkModeOverrides + data.html;

                if (isNearBottom || scrollPos === 0) {
                    scrollToBottom();
                } else {
                    chatContainer.scrollTop = scrollPos;
                }

            } catch (err) {
                console.error(err);
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        // --- Inputs ---
        // --- Inputs ---
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Optimistic UI updates
            const previousValue = messageInput.value;
            messageInput.value = ''; // Clear immediately
            messageInput.style.height = 'auto'; // Reset height
            messageInput.blur(); // Close keyboard on mobile immediately

            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.5';

            try {
                const res = await fetch('/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (res.ok) {
                    setTimeout(loadSnapshot, 300);
                } else {
                    // Revert if failed
                    const data = await res.json();
                    alert('Error sending: ' + (data.reason || 'Unknown'));
                    messageInput.value = previousValue;
                }
            } catch (e) {
                alert('Connection error');
                messageInput.value = previousValue;
            } finally {
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
                // Don't autofocus back, let user see the result
            }
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', sendMessage);

        refreshBtn.addEventListener('click', () => {
            // Refresh both Chat and State (Mode/Model)
            loadSnapshot();
            fetchAppState(); // PRIORITY: Sync from Desktop
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        chatContainer.addEventListener('scroll', () => {
            userIsScrolling = true;
            clearTimeout(idleTimer);

            const isNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 120;
            if (isNearBottom) {
                scrollToBottomBtn.classList.remove('show');
            } else {
                scrollToBottomBtn.classList.add('show');
            }

            idleTimer = setTimeout(() => {
                userIsScrolling = false;
                autoRefreshEnabled = true;
            }, 5000);
        });

        scrollToBottomBtn.addEventListener('click', () => {
            userIsScrolling = false;
            scrollToBottom();
        });

        // --- Quick Actions ---
        function quickAction(text) {
            messageInput.value = text;
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
            messageInput.focus();
        }

        // --- Stop Logic ---
        stopBtn.addEventListener('click', async () => {
            stopBtn.style.opacity = '0.5';
            try {
                const res = await fetch('/stop', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    // alert('Stopped');
                } else {
                    // alert('Error: ' + data.error);
                }
            } catch (e) { }
            setTimeout(() => stopBtn.style.opacity = '1', 500);
        });



        // --- Settings Logic ---

        function openModal(title, options, onSelect) {
            modalTitle.textContent = title;
            modalList.innerHTML = '';
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'modal-option';
                div.textContent = opt;
                div.onclick = () => {
                    onSelect(opt);
                    closeModal();
                };
                modalList.appendChild(div);
            });
            modalOverlay.classList.add('show');
        }

        function closeModal() {
            modalOverlay.classList.remove('show');
        }

        modalOverlay.onclick = (e) => {
            if (e.target === modalOverlay) closeModal();
        };

        modeBtn.addEventListener('click', () => {
            openModal('Select Mode', ['Fast', 'Planning'], async (mode) => {
                modeText.textContent = 'Setting...';
                try {
                    const res = await fetch('/set-mode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode })
                    });
                    const data = await res.json();
                    if (data.success) {
                        currentMode = mode;
                        modeText.textContent = mode;
                        modeBtn.classList.toggle('active', mode === 'Planning');
                    } else {
                        alert('Error: ' + (data.error || 'Unknown'));
                        modeText.textContent = currentMode;
                    }
                } catch (e) {
                    modeText.textContent = currentMode;
                }
            });
        });

        modelBtn.addEventListener('click', () => {
            openModal('Select Model', MODELS, async (model) => {
                const prev = modelText.textContent;
                modelText.textContent = 'Setting...';
                try {
                    const res = await fetch('/set-model', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model })
                    });
                    const data = await res.json();
                    if (data.success) {
                        modelText.textContent = model;
                    } else {
                        alert('Error: ' + (data.error || 'Unknown'));
                        modelText.textContent = prev;
                    }
                } catch (e) {
                    modelText.textContent = prev;
                }
            });
        });

        // --- Viewport / Keyboard Handling ---
        // This fixes the issue where the keyboard hides the input or layout breaks
        if (window.visualViewport) {
            function handleResize() {
                // Resize the body to match the visual viewport (screen minus keyboard)
                document.body.style.height = window.visualViewport.height + 'px';

                // Scroll to bottom if keyboard opened
                if (document.activeElement === messageInput) {
                    setTimeout(scrollToBottom, 100);
                }
            }

            window.visualViewport.addEventListener('resize', handleResize);
            window.visualViewport.addEventListener('scroll', handleResize);
            handleResize(); // Init
        }

        // --- Remote Click Logic (Thinking/Thought) ---
        chatContainer.addEventListener('click', async (e) => {
            // Strategy: Check if the clicked element OR its parent contains "Thought" or "Thinking" text.
            // This is more robust than looking for specific tags.

            // 1. Find the nearest container that might be the "Thought" block
            const target = e.target.closest('div, span, p, summary, button');
            if (!target) return;

            const text = target.innerText || '';

            // Check if this looks like a thought toggle
            if (text.includes('Thought') || text.includes('Thinking')) {
                // Determine what valid selector to capture.
                // We'll capture ALL elements with this text on the screen to find the index.
                const allEls = Array.from(chatContainer.querySelectorAll('*'));

                // Filter down to elements that have the same text
                // Use a heuristic: exact text match or very close
                const similarEls = allEls.filter(el =>
                    el.innerText === text && el.tagName === target.tagName
                );

                const index = similarEls.indexOf(target);

                if (index !== -1) {
                    try {
                        fetch('/remote-click', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                selector: target.tagName.toLowerCase(), // Not used meaningfully by new logic but passed
                                index: index,
                                textContent: text // Vital: we search by THIS text on server
                            })
                        });
                        setTimeout(loadSnapshot, 600);
                    } catch (e) { }
                }
            }
        });

        // --- Init ---
        connectWebSocket();
        // Sync state initially and every 5 seconds to keep phone in sync with desktop changes
        fetchAppState();
        setInterval(fetchAppState, 5000);

    </script>
</body>

</html>